// This is your Prisma schema file for WorkLedger
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum SubscriptionTier {
  STARTUP
  GROWTH
  ENTERPRISE
}

enum EmployeeRole {
  DEVELOPER
  DESIGNER
  MANAGER
  SALES
  MARKETING
  OTHER
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CertificateStatus {
  DRAFT
  ISSUED
  REVOKED
}

enum IntegrationType {
  GITHUB
  GITLAB
  SALESFORCE
  HUBSPOT
  JIRA
  SLACK
  OTHER
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

// Core Company Model
model Company {
  id          String           @id @default(cuid())
  name        String
  domain      String           @unique
  logoUrl     String?
  website     String?
  industry    String?
  size        String?

  // Subscription
  tier        SubscriptionTier @default(STARTUP)
  isActive    Boolean          @default(true)
  trialEnds   DateTime?

  // Settings
  settings    CompanySettings?

  // Relationships
  employees   Employee[]
  certificates Certificate[]
  integrations Integration[]
  auditLogs   AuditLog[]
  invitations Invitation[]
  repositories Repository[]
  githubInstallations GitHubInstallation[]
  githubOrganizationMembers GitHubOrganizationMember[]
  githubIntegrations GitHubIntegration[]
  githubWebhooks GitHubWebhook[]
  githubTokenAudits GitHubTokenAudit[]
  slackIntegrations SlackIntegration[]
  slackWorkspaces SlackWorkspace[]
  slackChannels SlackChannel[]
  slackWebhooks SlackWebhook[]
  jiraIntegrations JiraIntegration[]
  jiraProjects JiraProject[]
  jiraWebhooks JiraWebhook[]
  projects    Project[]

  // Metadata
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("companies")
}

// Company Settings & Privacy Controls
model CompanySettings {
  id               String   @id @default(cuid())
  companyId        String   @unique
  company          Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Privacy Settings
  shareSkills      Boolean  @default(true)
  shareAchievements Boolean @default(true)
  shareProjectTypes Boolean @default(true)
  shareTraining    Boolean  @default(true)
  shareTenure      Boolean  @default(true)

  // Certificate Customization
  certificateTemplate String?
  companyBranding  Boolean  @default(false)
  customFields     Json?    // Store additional custom fields

  // Automation Settings
  autoIssueEnabled Boolean  @default(false)
  minTrackingDays  Int      @default(30)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("company_settings")
}

// Employee Model
model Employee {
  id              String        @id @default(cuid())
  email           String        @unique
  firstName       String
  lastName        String
  avatarUrl       String?
  role            EmployeeRole  @default(OTHER)
  title           String?
  department      String?

  // Profile fields
  bio             String?       @db.Text
  linkedinUrl     String?
  personalWebsite String?

  // Company Relationship
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Employment Details
  startDate       DateTime      @default(now())
  endDate         DateTime?
  isActive        Boolean       @default(true)

  // External Integrations
  githubUsername  String?
  githubId        String?
  salesforceId    String?

  // Auto-discovery fields
  autoDiscovered  Boolean       @default(false)
  discoveryConfidence Float?    // 0.0 to 1.0

  // Relationships
  certificates    Certificate[]
  skillRecords    SkillRecord[]
  activities      GitHubActivity[]
  githubConnection GitHubConnection?
  employeeRepositories EmployeeRepository[]
  skillEvolutions SkillEvolution[]
  githubOrganizationMembers GitHubOrganizationMember[]
  githubTokenAudits GitHubTokenAudit[]
  slackUsers SlackUser[]
  slackMessages SlackMessage[]
  jiraUsers JiraUser[]
  jiraIssues JiraIssue[]
  jiraWorklogs JiraWorklog[]
  projectMembers ProjectMember[]

  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([companyId, email])
  @@index([companyId, isActive])
  @@map("employees")
}

// Skills Master Table
model Skill {
  id          String        @id @default(cuid())
  name        String        @unique
  category    String        // e.g., "Programming Language", "Framework", "Tool"
  description String?

  // Relationships
  skillRecords SkillRecord[]
  skillEvolutions SkillEvolution[]
  projectTechStacks ProjectTechStack[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("skills")
}

// Employee Skill Tracking
model SkillRecord {
  id          String     @id @default(cuid())
  employeeId  String
  employee    Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  skillId     String
  skill       Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)

  level       SkillLevel @default(BEGINNER)
  confidence  Float?     // 0.0 - 1.0 confidence score

  // Evidence tracking
  linesOfCode Int?
  projectsUsed Int?
  lastUsed    DateTime?

  // Auto-detected vs manual
  isAutoDetected Boolean @default(false)
  source         String? // e.g., "github", "manual", "training"

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([employeeId, skillId])
  @@index([employeeId])
  @@index([skillId])
  @@map("skill_records")
}

// GitHub Activity Tracking
model GitHubActivity {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Repository Info
  repoName        String
  repoFullName    String
  isPrivate       Boolean   @default(false)

  // Activity Data
  commits         Int       @default(0)
  pullRequests    Int       @default(0)
  linesAdded      Int       @default(0)
  linesDeleted    Int       @default(0)
  filesChanged    Int       @default(0)

  // Language Detection
  languages       Json      // Store language percentages
  frameworks      Json?     // Detected frameworks

  // Time Period
  periodStart     DateTime
  periodEnd       DateTime

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeeId, repoName, periodStart])
  @@index([employeeId, periodStart]) // Range queries for activity periods
  @@map("github_activities")
}

// Digital Certificates
model Certificate {
  id              String            @id @default(cuid())
  verificationId  String            @unique @default(cuid())

  // Employee & Company
  employeeId      String
  employee        Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Certificate Data
  title           String
  description     String?
  status          CertificateStatus @default(DRAFT)

  // Time Period
  periodStart     DateTime
  periodEnd       DateTime
  issueDate       DateTime          @default(now())
  expiryDate      DateTime?

  // Certificate Content (JSON)
  skillsData      Json              // Skills acquired/demonstrated
  achievements    Json              // Key achievements
  metrics         Json?             // Performance metrics (sanitized)

  // Security
  digitalSignature String?          // Cryptographic signature
  hashValue       String?           // Content hash for verification

  // File
  certificateFile CertificateFile?

  // Metadata
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([companyId])
  @@index([companyId, issueDate])
  @@map("certificates")
}

// External Integrations
model Integration {
  id           String          @id @default(cuid())
  companyId    String
  company      Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  type         IntegrationType
  name         String          // e.g., "GitHub Enterprise"

  // Configuration
  config       Json            // Store integration-specific config
  credentials  Json?           // Encrypted credentials

  // Status
  isActive     Boolean         @default(true)
  lastSync     DateTime?
  syncInterval Int?            // Minutes between syncs

  // Metadata
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@unique([companyId, type, name])
  @@map("integrations")
}

// Audit Logging for Security & Compliance
model AuditLog {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Event Details
  action      String   // e.g., "certificate_issued", "data_accessed"
  resource    String   // What was affected
  resourceId  String?  // ID of the affected resource

  // Actor
  actorType   String   // "employee", "admin", "system"
  actorId     String?  // ID of who performed the action
  actorEmail  String?

  // Context
  ipAddress   String?
  userAgent   String?
  metadata    Json?    // Additional context

  // Timestamp
  timestamp   DateTime @default(now())

  @@index([companyId, timestamp]) // Time-based log queries
  @@index([timestamp]) // Global time-based queries
  @@map("audit_logs")
}

// User Accounts (separate from employees for access control)
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?  // Hashed password

  // Profile
  firstName   String?
  lastName    String?
  avatarUrl   String?

  // Account Status
  isActive    Boolean  @default(true)
  emailVerified Boolean @default(false)

  // Role & Permissions
  role        String   @default("user") // "admin", "company_admin", "user"

  // Password Reset
  resetToken  String?
  resetExpires DateTime?

  // Sessions
  sessions    Session[]

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastLogin   DateTime?

  @@index([email]) // Frequent auth lookups by email
  @@map("users")
}

// Session Management
model Session {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  token       String   @unique
  expires     DateTime

  // Session Context
  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())

  @@map("sessions")
}

// Employee Invitation Management
model Invitation {
  id          String   @id @default(cuid())
  token       String   @unique @default(cuid())

  // Invitation details
  email       String
  firstName   String
  lastName    String
  role        EmployeeRole @default(OTHER)
  title       String?
  department  String?

  // Company relationship
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // GitHub linking (NEW for Phase 2)
  suggestedGithubUsername String?
  githubOrgMemberId       String?
  githubOrgMember         GitHubOrganizationMember? @relation(fields: [githubOrgMemberId], references: [id], onDelete: SetNull)

  // Invitation status
  status      String   @default("pending") // pending, accepted, expired, cancelled
  invitedBy   String   // Email of the person who sent the invitation

  // Timestamps
  expiresAt   DateTime @default(dbgenerated("NOW() + INTERVAL '7 days'"))
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([token])
  @@index([email, companyId])
  @@index([companyId, status])
  @@index([githubOrgMemberId])
  @@map("invitations")
}

// GitHub Connection for OAuth
model GitHubConnection {
  id              String   @id @default(cuid())
  employeeId      String   @unique
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // GitHub OAuth Data
  githubUserId    String   @unique
  githubUsername  String
  encryptedAccessToken  String?  // Encrypted (null for auto-discovered employees)
  encryptedRefreshToken String?  // Encrypted
  scope          String?

  // Connection Status
  isActive        Boolean  @default(true)
  isAutoDiscovered Boolean @default(false)
  lastSync        DateTime?

  // Metadata
  connectedAt     DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("github_connections")
}

// Repository Tracking (Company-level)
model Repository {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Repository Info
  githubRepoId    String   @unique
  name            String
  fullName        String
  isPrivate       Boolean  @default(false)
  isFork          Boolean  @default(false)

  // Repository Details
  description     String?
  homepage        String?
  defaultBranch   String?
  githubCreatedAt DateTime
  pushedAt        DateTime?

  // Repository Stats
  stars           Int      @default(0)
  forks           Int      @default(0)
  watchers        Int      @default(0)
  size            Int      @default(0)
  openIssues      Int      @default(0)

  // Language Data
  primaryLanguage String?
  languages       Json     @default("{}")  // {language: percentage}

  // Detected Frameworks
  frameworks      Json?    // ["react", "nextjs", etc]

  // Activity
  lastActivityAt  DateTime?
  totalCommits    Int      @default(0)

  // Relationships
  employeeRepositories EmployeeRepository[]
  activities      RepositoryActivity[]
  commits         Commit[]
  pullRequests    PullRequest[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([companyId, updatedAt])
  @@map("repositories")
}

// Employee Repository Contributions (Junction Table)
model EmployeeRepository {
  id              String     @id @default(cuid())
  employeeId      String
  employee        Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  // Contribution Metrics
  commitCount     Int        @default(0)
  linesAdded      Int        @default(0)
  linesDeleted    Int        @default(0)
  pullRequests    Int        @default(0)

  // Activity Tracking
  firstCommitAt   DateTime?
  lastCommitAt    DateTime?
  lastActivityAt  DateTime?

  // Role in repository
  isContributor   Boolean    @default(true)
  isOwner         Boolean    @default(false)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([employeeId, repositoryId])
  @@index([employeeId])
  @@index([repositoryId])
  @@index([repositoryId, commitCount])
  @@map("employee_repositories")
}

// Repository Activity Tracking
model RepositoryActivity {
  id              String     @id @default(cuid())
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  // Activity Period
  periodStart     DateTime
  periodEnd       DateTime

  // Contribution Metrics
  commits         Int        @default(0)
  pullRequests    Int        @default(0)
  issues          Int        @default(0)
  reviews         Int        @default(0)

  // Code Metrics
  linesAdded      Int        @default(0)
  linesDeleted    Int        @default(0)
  filesChanged    Int        @default(0)

  // Detected Skills
  detectedSkills  Json       // Skills found in this period

  createdAt       DateTime   @default(now())

  @@unique([repositoryId, periodStart, periodEnd])
  @@map("repository_activities")
}

// Skill Evolution Tracking
model SkillEvolution {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  skillId         String
  skill           Skill     @relation(fields: [skillId], references: [id])

  // Evolution Data
  date            DateTime
  level           SkillLevel
  confidence      Float     // 0.0 - 1.0

  // Evidence
  evidenceType    String    // "github", "training", "project", etc
  evidenceData    Json      // Context about how skill was demonstrated

  // Metrics at this point
  totalProjects   Int       @default(0)
  totalLines      Int       @default(0)

  createdAt       DateTime  @default(now())

  @@index([employeeId, skillId, date])
  @@map("skill_evolutions")
}

// Certificate Files Storage
model CertificateFile {
  id              String      @id @default(cuid())
  certificateId   String      @unique
  certificate     Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  // File Data
  fileUrl         String      // URL to PDF file
  fileHash        String      // SHA-256 hash of file
  fileSize        Int         // Size in bytes

  // QR Code
  qrCodeUrl       String?     // URL to QR code image

  // Verification
  publicKey       String      // Public key for verification
  signature       String      // Digital signature

  createdAt       DateTime    @default(now())

  @@map("certificate_files")
}

// Job Queue for Background Processing
model JobQueue {
  id              String   @id @default(cuid())

  // Job Info
  type            String   // "github_sync", "skill_analysis", "certificate_generation"
  status          String   // "pending", "processing", "completed", "failed"
  priority        Int      @default(0)

  // Job Data
  payload         Json     // Job-specific data
  result          Json?    // Job result data
  error           String?  // Error message if failed

  // Timing
  scheduledFor    DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  // Retry Logic
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type, status])
  @@index([scheduledFor])
  @@map("job_queue")
}

// Commit Tracking
model Commit {
  id              String     @id @default(cuid())
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  // Commit Info
  sha             String     @unique
  message         String
  authorName      String
  authorEmail     String
  authorDate      DateTime
  committerName   String?
  committerEmail  String?
  commitDate      DateTime

  // Commit Stats
  additions       Int        @default(0)
  deletions       Int        @default(0)
  filesChanged    Int        @default(0)

  // Files
  files           Json?      // Array of file paths changed

  // GitHub URLs
  htmlUrl         String?
  apiUrl          String?

  // Parent commits
  parentShas      String[]   // Array of parent commit SHAs

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([repositoryId, sha])
  @@index([repositoryId, authorDate])
  @@index([authorEmail])
  @@map("commits")
}

// Pull Request Tracking
model PullRequest {
  id              String     @id @default(cuid())
  repositoryId    String
  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  // PR Info
  number          Int
  title           String
  body            String?    @db.Text
  state           String     // open, closed, merged

  // Author Info
  authorUsername  String
  authorEmail     String?

  // PR Details
  headBranch      String
  baseBranch      String
  isDraft         Boolean    @default(false)
  isMerged        Boolean    @default(false)

  // Metrics
  additions       Int        @default(0)
  deletions       Int        @default(0)
  changedFiles    Int        @default(0)
  commits         Int        @default(0)
  comments        Int        @default(0)
  reviewComments  Int        @default(0)

  // Dates
  createdAt       DateTime
  updatedAt       DateTime
  closedAt        DateTime?
  mergedAt        DateTime?

  // GitHub URLs
  htmlUrl         String?
  apiUrl          String?

  // Additional data
  labels          String[]   // Array of label names
  assignees       String[]   // Array of assignee usernames
  requestedReviewers String[] // Array of reviewer usernames
  mergedBy        String?    // Username who merged

  @@unique([repositoryId, number])
  @@index([repositoryId, state])
  @@index([repositoryId, createdAt])
  @@index([authorUsername])
  @@map("pull_requests")
}

// GitHub App Installation tracking
model GitHubInstallation {
  id              String   @id @default(cuid())
  installationId  BigInt   @unique
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // GitHub organization details
  accountLogin    String   // Organization username
  accountId       BigInt
  accountType     String   @default("Organization")

  // Installation permissions and events
  permissions     Json     @default("{}")
  events          String[]

  // Repository access
  repositorySelection String @default("all") // 'all' or 'selected'
  selectedRepositories Json  @default("[]")

  // Status
  isActive        Boolean  @default(true)
  installedAt     DateTime @default(now())
  updatedAt       DateTime @updatedAt
  suspendedAt     DateTime?

  @@map("github_installations")
}

// GitHub Organization Members cache
model GitHubOrganizationMember {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  githubUserId    BigInt
  githubUsername  String
  githubEmail     String?
  githubName      String?

  // Employment verification
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])
  matchConfidence Float?    // 0.0 to 1.0
  matchMethod     String?   // 'email', 'name', 'manual', 'commit_analysis'

  // Organization role
  orgRole         String?   // 'member', 'admin', 'owner'
  orgPermissions  Json?

  // Invitations linked to this member (NEW for Phase 2)
  invitations     Invitation[]

  // Status
  isActive        Boolean   @default(true)
  discoveredAt    DateTime  @default(now())
  lastActivityAt  DateTime?

  @@unique([companyId, githubUserId])
  @@map("github_organization_members")
}

// GitHub Integration for company-level tokens
model GitHubIntegration {
  id              String   @id @default(cuid())
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tokenType       String   // 'oauth_access', 'app_installation', 'organization'

  // Encrypted token storage
  encryptedAccessToken  String
  encryptedRefreshToken String?

  // Token metadata
  expiresAt       DateTime?
  scope           String?
  organizationLogin String? // GitHub org username
  installationId  BigInt?   // For GitHub Apps

  // Additional data
  metadata        Json      @default("{}")

  // Status tracking
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deactivatedAt   DateTime?

  @@unique([companyId, tokenType])
  @@index([companyId, isActive])
  @@index([installationId])
  @@map("github_integrations")
}

// Webhook tracking
model GitHubWebhook {
  id              String    @id @default(cuid())
  installationId  BigInt?
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Webhook details
  eventType       String
  action          String?
  payload         Json

  // Processing status
  processed       Boolean   @default(false)
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int       @default(0)

  // Metadata
  receivedAt      DateTime  @default(now())
  githubDeliveryId String?

  @@index([processed, receivedAt])
  @@index([companyId, eventType, receivedAt])
  @@map("github_webhooks")
}

// Audit trail for token operations
model GitHubTokenAudit {
  id              String    @id @default(cuid())
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Operation details
  operation       String    // 'created', 'refreshed', 'revoked', 'expired'
  tokenType       String

  // Context
  userAgent       String?
  ipAddress       String?
  userId          String?   // Who performed the operation

  // Metadata
  metadata        Json      @default("{}")
  createdAt       DateTime  @default(now())

  @@map("github_token_audit")
}

// Indexes for Performance
// @@index([companyId]) // Already covered by foreign keys
// @@index([employeeId]) // Already covered by foreign keys

// ============================================
// SLACK INTEGRATION MODELS
// ============================================

// Slack Integration (OAuth tokens and workspace connection)
model SlackIntegration {
  id              String    @id @default(cuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Slack workspace details
  teamId          String    @unique // Slack team/workspace ID
  teamName        String
  teamDomain      String?

  // Encrypted token storage
  encryptedAccessToken  String
  encryptedRefreshToken String?

  // Bot/App details
  botUserId       String?   // Bot user ID
  botAccessToken  String?   // Encrypted bot token
  scope           String?   // Granted scopes

  // Status tracking
  isActive        Boolean   @default(true)
  lastSync        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deactivatedAt   DateTime?

  // Relationships
  workspace       SlackWorkspace?

  @@unique([companyId, teamId])
  @@index([companyId, isActive])
  @@map("slack_integrations")
}

// Slack Workspace (Team info)
model SlackWorkspace {
  id              String    @id @default(cuid())
  integrationId   String    @unique
  integration     SlackIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Workspace details
  teamId          String
  teamName        String
  teamDomain      String?
  teamUrl         String?
  teamIcon        String?

  // Workspace stats
  totalMembers    Int       @default(0)
  totalChannels   Int       @default(0)
  totalMessages   Int       @default(0)

  // Enterprise info
  enterpriseId    String?
  enterpriseName  String?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([companyId, teamId])
  @@map("slack_workspaces")
}

// Slack Channels
model SlackChannel {
  id              String    @id @default(cuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Channel details
  slackChannelId  String    // Slack's channel ID (e.g., C1234567890)
  name            String
  nameNormalized  String?
  topic           String?
  purpose         String?

  // Channel type
  isPrivate       Boolean   @default(false)
  isArchived      Boolean   @default(false)
  isGeneral       Boolean   @default(false)

  // Channel stats
  memberCount     Int       @default(0)
  messageCount    Int       @default(0)
  lastActivityAt  DateTime?

  // Creator
  creatorId       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  messages        SlackMessage[]

  @@unique([companyId, slackChannelId])
  @@index([companyId, isArchived])
  @@map("slack_channels")
}

// Slack Users (mapped to employees)
model SlackUser {
  id              String    @id @default(cuid())
  companyId       String
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Slack user details
  slackUserId     String    // Slack's user ID (e.g., U1234567890)
  slackUsername   String
  realName        String?
  displayName     String?
  email           String?
  title           String?
  phone           String?

  // Profile
  avatarUrl       String?
  statusText      String?
  statusEmoji     String?

  // User state
  isBot           Boolean   @default(false)
  isAdmin         Boolean   @default(false)
  isOwner         Boolean   @default(false)
  isDeleted       Boolean   @default(false)
  isRestricted    Boolean   @default(false)

  // Timezone
  timezone        String?
  timezoneOffset  Int?      // Offset in seconds

  // Employee matching
  matchConfidence Float?    // 0.0 to 1.0
  matchMethod     String?   // 'email', 'name', 'manual'

  // Activity stats
  totalMessages   Int       @default(0)
  lastActivityAt  DateTime?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  messages        SlackMessage[]

  @@unique([companyId, slackUserId])
  @@index([employeeId])
  @@index([email])
  @@map("slack_users")
}

// Slack Messages (aggregated for privacy)
model SlackMessage {
  id              String    @id @default(cuid())
  companyId       String
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  slackUserId     String?
  slackUser       SlackUser? @relation(fields: [slackUserId], references: [id], onDelete: SetNull)
  channelId       String
  channel         SlackChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  // Message details
  messageTs       String    @unique // Slack timestamp (for deduplication)
  messageType     String    @default("message") // message, thread_reply, etc
  text            String    @db.Text // Message content

  // Thread information
  threadTs        String?   // Parent message timestamp if this is a reply
  isThreadReply   Boolean   @default(false)
  replyCount      Int       @default(0) // Number of replies if this is a parent

  // Message timestamp
  timestamp       DateTime  // Exact message timestamp
  date            DateTime  // Date only (for aggregation)
  hour            Int       // Hour of day (0-23)

  // Message metadata
  mentions        Json?     // Array of mentioned user IDs
  reactions       Json?     // Reaction data
  attachments     Json?     // File attachments
  links           Json?     // Extracted links

  // Analytics counters
  mentionCount    Int       @default(0)
  reactionCount   Int       @default(0)
  linkCount       Int       @default(0)
  fileCount       Int       @default(0)

  // Response metrics
  hasResponse     Boolean   @default(false)
  responseTimeMinutes Int?  // Time to first response in thread

  // AI Analysis (to be added later)
  sentimentScore  Float?    // -1.0 to 1.0
  clarityScore    Float?    // 0.0 to 1.0
  professionalismScore Float? // 0.0 to 1.0
  analyzedAt      DateTime?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId, date])
  @@index([employeeId, date])
  @@index([channelId, date])
  @@index([threadTs])
  @@index([messageTs])
  @@map("slack_messages")
}

// Slack Webhooks
model SlackWebhook {
  id              String    @id @default(cuid())
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Webhook details
  eventType       String    // message.channels, user.changed, etc
  eventSubtype    String?
  payload         Json

  // Processing status
  processed       Boolean   @default(false)
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int       @default(0)

  // Metadata
  receivedAt      DateTime  @default(now())
  slackEventId    String?   // Slack's event ID for deduplication

  @@index([processed, receivedAt])
  @@index([companyId, eventType, receivedAt])
  @@index([slackEventId])
  @@map("slack_webhooks")
}

// ================================
// JIRA INTEGRATION
// ================================

// Jira Integration
model JiraIntegration {
  id              String    @id @default(cuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Jira instance details
  cloudId         String    @unique // Atlassian Cloud ID
  siteUrl         String    // e.g., https://yourcompany.atlassian.net
  siteName        String

  // Encrypted token storage
  encryptedAccessToken  String
  encryptedRefreshToken String?

  // Token expiry
  tokenExpiresAt  DateTime?

  // Account details
  accountId       String?   // Atlassian account ID
  accountEmail    String?

  // Status tracking
  isActive        Boolean   @default(true)
  lastSync        DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deactivatedAt   DateTime?

  // Relationships
  projects        JiraProject[]

  @@unique([companyId, cloudId])
  @@index([companyId, isActive])
  @@map("jira_integrations")
}

// Jira Projects
model JiraProject {
  id              String    @id @default(cuid())
  integrationId   String
  integration     JiraIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Project details
  jiraProjectId   String    // Jira's project ID
  projectKey      String    // e.g., "WORK", "DEV"
  name            String
  description     String?   @db.Text
  avatarUrl       String?

  // Project type
  projectType     String?   // software, business, service_desk
  projectStyle    String?   // classic, next-gen

  // Lead information
  leadAccountId   String?
  leadDisplayName String?

  // Project stats
  issueCount      Int       @default(0)
  completedIssues Int       @default(0)

  // Status
  isArchived      Boolean   @default(false)

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  issues          JiraIssue[]

  @@unique([companyId, jiraProjectId])
  @@index([companyId])
  @@index([projectKey])
  @@map("jira_projects")
}

// Jira Users (for matching with employees)
model JiraUser {
  id              String    @id @default(cuid())
  companyId       String
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Jira user details
  accountId       String    // Atlassian account ID
  displayName     String
  email           String?
  avatarUrl       String?

  // User state
  isActive        Boolean   @default(true)
  accountType     String?   // atlassian, app, customer

  // Matching
  matchConfidence Float?    // 0.0 - 1.0
  matchMethod     String?   // email, name, manual

  // Activity tracking
  issuesCreated   Int       @default(0)
  issuesAssigned  Int       @default(0)
  issuesCompleted Int       @default(0)
  commentsPosted  Int       @default(0)
  lastActivityAt  DateTime?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  createdIssues   JiraIssue[] @relation("IssueCreator")
  assignedIssues  JiraIssue[] @relation("IssueAssignee")
  comments        JiraComment[]
  workLogs        JiraWorklog[]

  @@unique([companyId, accountId])
  @@index([companyId])
  @@index([employeeId])
  @@map("jira_users")
}

// Jira Issues
model JiraIssue {
  id              String    @id @default(cuid())
  companyId       String
  projectId       String
  project         JiraProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Creator
  creatorId       String?
  creator         JiraUser? @relation("IssueCreator", fields: [creatorId], references: [id], onDelete: SetNull)

  // Assignee
  assigneeId      String?
  assignee        JiraUser? @relation("IssueAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Issue details
  jiraIssueId     String    @unique // Jira's issue ID
  issueKey        String    // e.g., "WORK-123"
  summary         String
  description     String?   @db.Text

  // Issue type
  issueType       String    // Story, Task, Bug, Epic, Subtask
  issueTypeIconUrl String?

  // Status
  status          String    // To Do, In Progress, Done, etc
  statusCategory  String    // new, indeterminate, done

  // Priority
  priority        String?   // Highest, High, Medium, Low, Lowest
  priorityIconUrl String?

  // Story points and estimation
  storyPoints     Int?
  originalEstimate Int?     // Minutes
  timeSpent       Int?      // Minutes
  remainingEstimate Int?    // Minutes

  // Labels and components
  labels          Json?     // Array of label strings
  components      Json?     // Array of component objects

  // Dates
  createdDate     DateTime
  updatedDate     DateTime
  resolvedDate    DateTime?
  dueDate         DateTime?

  // Resolution
  resolution      String?   // Done, Won't Do, Duplicate, etc
  resolutionDate  DateTime?

  // Parent/Epic
  parentIssueKey  String?
  epicKey         String?

  // URL
  webUrl          String?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relationships
  comments        JiraComment[]
  workLogs        JiraWorklog[]
  transitions     JiraIssueTransition[]

  @@unique([companyId, jiraIssueId])
  @@index([companyId, status])
  @@index([projectId])
  @@index([assigneeId])
  @@index([employeeId])
  @@index([issueKey])
  @@map("jira_issues")
}

// Jira Comments
model JiraComment {
  id              String    @id @default(cuid())
  companyId       String
  issueId         String
  issue           JiraIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  // Author
  authorId        String?
  author          JiraUser? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  // Comment details
  jiraCommentId   String    @unique
  body            String    @db.Text

  // Timestamps
  createdDate     DateTime
  updatedDate     DateTime

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([issueId])
  @@index([authorId])
  @@map("jira_comments")
}

// Jira Work Logs (time tracking)
model JiraWorklog {
  id              String    @id @default(cuid())
  companyId       String
  issueId         String
  issue           JiraIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  // Author
  authorId        String?
  author          JiraUser? @relation(fields: [authorId], references: [id], onDelete: SetNull)
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  // Worklog details
  jiraWorklogId   String    @unique
  comment         String?   @db.Text
  timeSpentSeconds Int      // Time logged in seconds

  // Timestamps
  startedDate     DateTime
  createdDate     DateTime
  updatedDate     DateTime

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([issueId])
  @@index([authorId])
  @@index([employeeId])
  @@index([startedDate])
  @@map("jira_worklogs")
}

// Jira Issue Transitions (status changes)
model JiraIssueTransition {
  id              String    @id @default(cuid())
  companyId       String
  issueId         String
  issue           JiraIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  // Transition details
  fromStatus      String
  toStatus        String
  fromStatusCategory String
  toStatusCategory String

  // Who made the change
  authorAccountId String?
  authorDisplayName String?

  // Timestamp
  transitionDate  DateTime

  // Metadata
  createdAt       DateTime  @default(now())

  @@index([companyId])
  @@index([issueId])
  @@index([transitionDate])
  @@map("jira_issue_transitions")
}

// Jira Webhooks
model JiraWebhook {
  id              String    @id @default(cuid())
  companyId       String?
  company         Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Webhook details
  eventType       String    // jira:issue_created, jira:issue_updated, etc
  webhookEvent    String?   // issue_created, issue_updated, worklog_updated
  issueKey        String?
  payload         Json

  // Processing status
  processed       Boolean   @default(false)
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int       @default(0)

  // Metadata
  receivedAt      DateTime  @default(now())
  jiraEventId     String?   // Jira's event ID for deduplication

  @@index([processed, receivedAt])
  @@index([companyId, eventType, receivedAt])
  @@index([jiraEventId])
  @@map("jira_webhooks")
}

// ============================================
// PROJECT MANAGEMENT
// ============================================

// Project Model
model Project {
  id              String        @id @default(cuid())
  companyId       String
  company         Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Project Details
  name            String
  description     String?       @db.Text
  status          ProjectStatus @default(PLANNING)

  // Timeline
  startDate       DateTime?
  endDate         DateTime?
  deadline        DateTime?

  // Budget & Priority
  budget          Float?
  priority        String?       // HIGH, MEDIUM, LOW

  // Created by
  createdById     String?       // User ID who created the project

  // Relationships
  techStack       ProjectTechStack[]
  members         ProjectMember[]

  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([companyId])
  @@index([companyId, status])
  @@map("projects")
}

// Project Tech Stack (Junction table for Project <-> Skill)
model ProjectTechStack {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  skillId         String
  skill           Skill     @relation(fields: [skillId], references: [id], onDelete: Cascade)

  // Optional: Mark if this skill is required or nice-to-have
  isRequired      Boolean   @default(true)
  priority        Int       @default(1)  // 1 = highest priority

  createdAt       DateTime  @default(now())

  @@unique([projectId, skillId])
  @@index([projectId])
  @@index([skillId])
  @@map("project_tech_stacks")
}

// Project Member (Junction table for Project <-> Employee)
model ProjectMember {
  id              String    @id @default(cuid())
  projectId       String
  project         Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Member Role in Project
  role            String?   // Lead, Developer, Designer, etc.
  isLead          Boolean   @default(false)

  // Assignment Details
  assignedAt      DateTime  @default(now())
  removedAt       DateTime?

  // Recommendation Data (if assigned via recommendation)
  matchScore      Float?    // 0.0 - 1.0 match score when recommended
  wasRecommended  Boolean   @default(false)

  // Status
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([projectId, employeeId])
  @@index([projectId])
  @@index([employeeId])
  @@index([projectId, isActive])
  @@map("project_members")
}